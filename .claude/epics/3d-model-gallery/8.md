---
name: Download System
status: open
created: 2025-10-23T05:35:03Z
updated: 2025-10-23T07:00:09Z
github: https://github.com/duanbo1/nuxt-3d-gallery/issues/8
depends_on: [5, 7]
parallel: true
conflicts_with: []
---

# Task: Download System

## Description
Implement the complete download functionality including the DownloadButton component, integration with download tracking API, format selection for multi-format models, attribution file generation with license information, and success notifications with analytics.

## Acceptance Criteria
- [ ] `DownloadButton.vue` component implemented
- [ ] Download triggers direct file download
- [ ] Download counter increments via API call
- [ ] Format selection dropdown for models with multiple formats
- [ ] Attribution.txt file generated with license and credit info
- [ ] Success toast notification after download starts
- [ ] Analytics tracked (model ID, format, timestamp)
- [ ] Loading state during API call
- [ ] Error handling for failed downloads

## Technical Details

### Implementation Approach

1. **Create DownloadButton Component** (`/components/DownloadButton.vue`):
   ```vue
   <template>
     <button
       @click="handleDownload"
       :disabled="isDownloading"
       class="download-btn flex items-center justify-between w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white rounded-md transition-colors"
     >
       <div class="flex items-center gap-2">
         <IconDownload class="w-5 h-5" />
         <div class="text-left">
           <div class="font-semibold">{{ format.type }}</div>
           <div class="text-xs opacity-90">{{ format.size }}</div>
         </div>
       </div>

       <div v-if="isDownloading" class="spinner-small"></div>
       <IconChevronRight v-else class="w-5 h-5" />
     </button>
   </template>

   <script setup lang="ts">
   import type { Format } from '~/schemas/model.schema'

   const props = defineProps<{
     modelId: string
     format: Format
   }>()

   const isDownloading = ref(false)
   const { showToast } = useToast()

   const handleDownload = async () => {
     if (isDownloading.value) return

     isDownloading.value = true

     try {
       // Track download via API
       await $fetch(`/api/models/${props.modelId}/download`, {
         method: 'POST',
         body: {
           format: props.format.type
         }
       })

       // Trigger file download
       const link = document.createElement('a')
       link.href = props.format.url
       link.download = props.format.url.split('/').pop() || 'model'
       document.body.appendChild(link)
       link.click()
       document.body.removeChild(link)

       // Generate and download attribution file
       await downloadAttributionFile()

       // Show success notification
       showToast({
         type: 'success',
         message: `${props.format.type} download started!`,
         duration: 3000
       })

       // Log analytics
       logDownloadAnalytics()
     } catch (error) {
       console.error('Download failed:', error)
       showToast({
         type: 'error',
         message: 'Download failed. Please try again.',
         duration: 5000
       })
     } finally {
       isDownloading.value = false
     }
   }

   const downloadAttributionFile = async () => {
     try {
       // Get model data
       const { getModelBySlug } = useModels()
       // Find model by ID (need to search through all models)
       const { models } = useModels()
       const model = models.value.find(m => m.id === props.modelId)

       if (!model) return

       // Generate attribution content
       const attributionContent = `
3D Model Attribution
====================

Model: ${model.name}
Author: ${model.author}
License: ${model.license}
Source: ${window.location.origin}/models/${model.slug}

Downloaded: ${new Date().toLocaleString()}
Format: ${props.format.type}

License Terms:
${getLicenseTerms(model.license)}

Please credit the author when using this model.
Visit the source URL for more information.
`.trim()

       // Create and download attribution file
       const blob = new Blob([attributionContent], { type: 'text/plain' })
       const url = URL.createObjectURL(blob)
       const link = document.createElement('a')
       link.href = url
       link.download = `${model.slug}-attribution.txt`
       document.body.appendChild(link)
       link.click()
       document.body.removeChild(link)
       URL.revokeObjectURL(url)
     } catch (error) {
       console.error('Failed to generate attribution file:', error)
       // Non-critical error, don't show to user
     }
   }

   const getLicenseTerms = (license: string): string => {
     const terms: Record<string, string> = {
       'CC BY 4.0': 'Attribution required. You may use, modify, and distribute this work, even commercially, as long as you credit the original author.',
       'CC BY-SA 4.0': 'Attribution required. Share-alike: derivative works must use the same license.',
       'CC BY-NC 4.0': 'Attribution required. Non-commercial use only.',
       'CC0': 'Public domain. No attribution required, but appreciated.'
     }
     return terms[license] || 'See license documentation for details.'
   }

   const logDownloadAnalytics = () => {
     // Could be expanded to use analytics service (Plausible, Umami, etc.)
     if (typeof window !== 'undefined' && (window as any).plausible) {
       (window as any).plausible('Download', {
         props: {
           modelId: props.modelId,
           format: props.format.type
         }
       })
     }
   }
   </script>

   <style scoped>
   .spinner-small {
     border: 2px solid rgba(255, 255, 255, 0.3);
     border-top-color: white;
     border-radius: 50%;
     width: 20px;
     height: 20px;
     animation: spin 0.8s linear infinite;
   }

   @keyframes spin {
     to { transform: rotate(360deg); }
   }
   </style>
   ```

2. **Create Toast Notification Composable** (`/composables/useToast.ts`):
   ```typescript
   interface Toast {
     id: string
     type: 'success' | 'error' | 'info'
     message: string
     duration: number
   }

   export const useToast = () => {
     const toasts = useState<Toast[]>('toasts', () => [])

     const showToast = (options: Omit<Toast, 'id'>) => {
       const id = Math.random().toString(36).substr(2, 9)
       const toast: Toast = { ...options, id }

       toasts.value.push(toast)

       // Auto-remove after duration
       setTimeout(() => {
         removeToast(id)
       }, options.duration)
     }

     const removeToast = (id: string) => {
       const index = toasts.value.findIndex(t => t.id === id)
       if (index > -1) {
         toasts.value.splice(index, 1)
       }
     }

     return {
       toasts: readonly(toasts),
       showToast,
       removeToast
     }
   }
   ```

3. **Create Toast Container Component** (`/components/ToastContainer.vue`):
   ```vue
   <template>
     <div class="toast-container fixed top-4 right-4 z-50 space-y-2">
       <TransitionGroup name="toast">
         <div
           v-for="toast in toasts"
           :key="toast.id"
           :class="[
             'toast px-4 py-3 rounded-lg shadow-lg text-white max-w-sm',
             toast.type === 'success' && 'bg-green-500',
             toast.type === 'error' && 'bg-red-500',
             toast.type === 'info' && 'bg-blue-500'
           ]"
         >
           <div class="flex items-center justify-between gap-3">
             <div class="flex items-center gap-2">
               <IconCheck v-if="toast.type === 'success'" class="w-5 h-5" />
               <IconError v-if="toast.type === 'error'" class="w-5 h-5" />
               <IconInfo v-if="toast.type === 'info'" class="w-5 h-5" />
               <span class="text-sm">{{ toast.message }}</span>
             </div>
             <button
               @click="removeToast(toast.id)"
               class="text-white hover:text-gray-200"
             >
               <IconClose class="w-4 h-4" />
             </button>
           </div>
         </div>
       </TransitionGroup>
     </div>
   </template>

   <script setup lang="ts">
   const { toasts, removeToast } = useToast()
   </script>

   <style scoped>
   .toast-enter-active,
   .toast-leave-active {
     transition: all 0.3s ease;
   }

   .toast-enter-from {
     opacity: 0;
     transform: translateX(100%);
   }

   .toast-leave-to {
     opacity: 0;
     transform: translateX(100%);
   }
   </style>
   ```

4. **Add Toast Container to Layout** (`/app.vue` or layout file):
   ```vue
   <template>
     <div>
       <NuxtLayout>
         <NuxtPage />
       </NuxtLayout>
       <ToastContainer />
     </div>
   </template>
   ```

5. **Update Download API** (ensure it logs format):
   Modify `/server/api/models/[id]/download.post.ts` to accept format parameter in body.

### Key Considerations
- **User Experience**: Clear feedback during download process
- **Attribution**: Automatic license information with downloads
- **Analytics**: Track downloads for insights
- **Error Handling**: Graceful handling of network failures
- **Accessibility**: Proper ARIA labels, keyboard support

### Code Locations/Files Affected
- New files:
  - `/components/DownloadButton.vue`
  - `/components/ToastContainer.vue`
  - `/composables/useToast.ts`
- Modified files: `/server/api/models/[id]/download.post.ts`

## Dependencies
- [ ] Task 5 completed (API routes)
- [ ] Task 7 completed (model detail page for integration)

## Effort Estimate
- **Size**: S (Small)
- **Hours**: 8 hours
- **Parallel**: true
- **Complexity**: Low-Medium

### Time Breakdown
- DownloadButton component: 2 hours
- Attribution file generation: 2 hours
- Toast notification system: 2 hours
- API integration and testing: 2 hours

## Definition of Done
- [ ] Code implemented: All components complete
- [ ] Tests passing: Download flow works end-to-end
- [ ] Documentation updated: Component usage documented
- [ ] Code reviewed: Security and UX verified
- [ ] Ready for use: Can download models with tracking
- [ ] Verified: Downloads increment counter correctly
- [ ] Verified: Attribution file downloads automatically
- [ ] Verified: Toast notifications appear and dismiss
- [ ] Verified: Error states handled gracefully
