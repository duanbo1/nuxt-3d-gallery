---
name: Comment System Integration
status: open
created: 2025-10-23T05:35:03Z
updated: 2025-10-23T05:35:03Z
github: [Will be updated when synced to GitHub]
depends_on: [006]
parallel: true
conflicts_with: []
---

# Task: Comment System Integration

## Description
Integrate Giscus comment system powered by GitHub Discussions into model detail pages. Configure GitHub repository connection, create CommentSection component with lazy loading, implement theme synchronization with site theme, and add comment count badges to model cards.

## Acceptance Criteria
- [ ] Giscus configured with GitHub repository
- [ ] `CommentSection.vue` component implemented
- [ ] Comments load lazily (only when section is in viewport)
- [ ] GitHub OAuth login flow functional
- [ ] Comment threading/replies supported
- [ ] Comment count displayed on model cards
- [ ] Dark/light theme synchronization
- [ ] Comments persist in GitHub Discussions
- [ ] Mobile-responsive comment UI

## Technical Details

### Implementation Approach

1. **Setup GitHub Repository for Giscus**:
   - Create/use existing GitHub repository
   - Enable Discussions in repository settings
   - Install Giscus app: https://github.com/apps/giscus
   - Configure repository as public
   - Get repository ID and category ID from Giscus website

2. **Create CommentSection Component** (`/components/CommentSection.vue`):
   ```vue
   <template>
     <div class="comment-section">
       <h2 class="text-2xl font-bold mb-4">Comments</h2>

       <!-- Lazy load comments -->
       <div ref="commentContainer" class="min-h-[200px]">
         <ClientOnly>
           <div v-if="shouldLoadComments">
             <Giscus
               :repo="config.giscus.repo"
               :repo-id="config.giscus.repoId"
               :category="config.giscus.category"
               :category-id="config.giscus.categoryId"
               :mapping="config.giscus.mapping"
               :term="commentTerm"
               :reactions-enabled="1"
               :emit-metadata="1"
               :input-position="config.giscus.inputPosition"
               :theme="giscusTheme"
               :lang="config.giscus.lang"
               :loading="'lazy'"
               @discussion-created="onDiscussionCreated"
               @discussion-updated="onDiscussionUpdated"
             />
           </div>

           <template #fallback>
             <div class="text-center py-8 text-gray-500">
               <p>Loading comments...</p>
             </div>
           </template>
         </ClientOnly>
       </div>
     </div>
   </template>

   <script setup lang="ts">
   import Giscus from '@giscus/vue'

   const props = defineProps<{
     modelId: string
     modelSlug: string
   }>()

   // Giscus configuration
   const config = {
     giscus: {
       repo: 'username/repo-name', // Update with actual repo
       repoId: 'R_xxxxxxxxxxxxx', // Get from giscus.app
       category: 'Models',
       categoryId: 'DIC_xxxxxxxxxxxxx', // Get from giscus.app
       mapping: 'specific',
       inputPosition: 'top',
       lang: 'en'
     }
   }

   // Comment term (unique identifier for each model)
   const commentTerm = computed(() => `model-${props.modelSlug}`)

   // Theme synchronization
   const colorMode = useColorMode()
   const giscusTheme = computed(() => {
     return colorMode.value === 'dark'
       ? 'transparent_dark'
       : 'light'
   })

   // Lazy loading with Intersection Observer
   const commentContainer = ref<HTMLElement>()
   const shouldLoadComments = ref(false)

   onMounted(() => {
     if (!commentContainer.value) return

     const observer = new IntersectionObserver(
       (entries) => {
         entries.forEach((entry) => {
           if (entry.isIntersecting) {
             shouldLoadComments.value = true
             observer.disconnect()
           }
         })
       },
       { rootMargin: '200px' } // Load 200px before entering viewport
     )

     observer.observe(commentContainer.value)

     onBeforeUnmount(() => {
       observer.disconnect()
     })
   })

   // Event handlers
   const onDiscussionCreated = (event: any) => {
     console.log('Discussion created:', event)
     // Could emit event to update comment count
   }

   const onDiscussionUpdated = (event: any) => {
     console.log('Discussion updated:', event)
     // Could emit event to update comment count
   }
   </script>

   <style scoped>
   .comment-section {
     margin-top: 3rem;
     padding-top: 2rem;
     border-top: 1px solid #e5e7eb;
   }

   @media (prefers-color-scheme: dark) {
     .comment-section {
       border-top-color: #374151;
     }
   }
   </style>
   ```

3. **Add to Model Detail Page** (`/pages/models/[slug].vue`):
   ```vue
   <template>
     <div class="container mx-auto px-4 py-8">
       <!-- ... existing model detail content ... -->

       <!-- Comments section -->
       <CommentSection
         :model-id="model.id"
         :model-slug="model.slug"
       />
     </div>
   </template>
   ```

4. **Create Comment Count Fetcher** (`/composables/useCommentCount.ts`):
   ```typescript
   // Optional: Fetch comment counts from GitHub API
   interface CommentCount {
     [modelId: string]: number
   }

   export const useCommentCount = () => {
     const commentCounts = useState<CommentCount>('comment-counts', () => ({}))

     const fetchCommentCount = async (modelSlug: string): Promise<number> => {
       // Check cache first
       if (commentCounts.value[modelSlug] !== undefined) {
         return commentCounts.value[modelSlug]
       }

       try {
         // GitHub Discussions GraphQL API
         // Note: Requires GitHub token for API access
         // For MVP, this can be skipped and counts won't be shown
         // Alternatively, Giscus provides metadata that can be captured

         // Placeholder implementation
         const count = 0
         commentCounts.value[modelSlug] = count
         return count
       } catch (error) {
         console.error('Failed to fetch comment count:', error)
         return 0
       }
     }

     return {
       commentCounts,
       fetchCommentCount
     }
   }
   ```

5. **Update ModelCard with Comment Count** (`/components/ModelCard.vue`):
   ```vue
   <template>
     <div class="model-card">
       <!-- ... existing card content ... -->

       <!-- Stats -->
       <div class="flex items-center justify-between text-sm text-gray-500">
         <div class="flex items-center gap-1">
           <IconDownload class="w-4 h-4" />
           <span>{{ model.downloads }}</span>
         </div>

         <!-- Comment count (if available) -->
         <div v-if="commentCount > 0" class="flex items-center gap-1">
           <IconComment class="w-4 h-4" />
           <span>{{ commentCount }}</span>
         </div>

         <!-- ... other stats ... -->
       </div>
     </div>
   </template>

   <script setup lang="ts">
   const props = defineProps<{
     model: Model
   }>()

   // Fetch comment count (optional)
   const { fetchCommentCount } = useCommentCount()
   const commentCount = ref(0)

   onMounted(async () => {
     commentCount.value = await fetchCommentCount(props.model.slug)
   })
   </script>
   ```

6. **Setup Color Mode Module** (if not already installed):
   ```bash
   pnpm add @nuxtjs/color-mode
   ```

   Add to `nuxt.config.ts`:
   ```typescript
   export default defineNuxtConfig({
     modules: [
       '@nuxtjs/color-mode',
       // ... other modules
     ],

     colorMode: {
       classSuffix: '',
       preference: 'system', // default theme
       fallback: 'light'
     }
   })
   ```

7. **Environment Configuration** (`.env`):
   ```env
   # Giscus Configuration
   NUXT_PUBLIC_GISCUS_REPO=username/repo-name
   NUXT_PUBLIC_GISCUS_REPO_ID=R_xxxxxxxxxxxxx
   NUXT_PUBLIC_GISCUS_CATEGORY=Models
   NUXT_PUBLIC_GISCUS_CATEGORY_ID=DIC_xxxxxxxxxxxxx
   ```

8. **Create Setup Documentation** (`docs/giscus-setup.md`):
   ```markdown
   # Giscus Setup Guide

   ## Prerequisites
   1. GitHub repository (can be the project repo or separate)
   2. Repository must be public
   3. Discussions enabled on repository

   ## Steps

   1. **Enable Discussions**:
      - Go to repository Settings
      - Check "Discussions" under Features

   2. **Install Giscus App**:
      - Visit: https://github.com/apps/giscus
      - Click "Install"
      - Select repository

   3. **Get Configuration**:
      - Visit: https://giscus.app
      - Enter repository name
      - Select "Discussions" category
      - Choose mapping: "Discussion title contains page pathname"
      - Copy repo ID and category ID

   4. **Update Environment Variables**:
      - Add values to .env file
      - Redeploy application

   ## Creating a Category

   1. Go to repository Discussions
   2. Click "New category"
   3. Name: "Models"
   4. Description: "Comments for 3D models"
   5. Format: "Open-ended discussion"
   ```

### Key Considerations
- **GitHub Dependency**: Requires public GitHub repository
- **Privacy**: Users need GitHub account to comment
- **Rate Limits**: GitHub API has rate limits
- **Lazy Loading**: Improve page performance by loading comments on scroll
- **Theme Sync**: Match site's dark/light mode

### Code Locations/Files Affected
- New files:
  - `/components/CommentSection.vue`
  - `/composables/useCommentCount.ts` (optional)
  - `/docs/giscus-setup.md`
- Modified files:
  - `/pages/models/[slug].vue`
  - `/components/ModelCard.vue` (optional comment count)
  - `nuxt.config.ts`
  - `.env`
- Packages: Install `@giscus/vue`, `@nuxtjs/color-mode`

## Dependencies
- [ ] Task 006 completed (model detail pages)
- [ ] GitHub repository created and configured
- [ ] Giscus app installed on repository

## Effort Estimate
- **Size**: S (Small)
- **Hours**: 6 hours
- **Parallel**: true
- **Complexity**: Low (mostly configuration)

### Time Breakdown
- GitHub/Giscus setup: 1 hour
- CommentSection component: 2 hours
- Theme synchronization: 1 hour
- Lazy loading implementation: 1 hour
- Testing and documentation: 1 hour

## Definition of Done
- [ ] Code implemented: CommentSection component complete
- [ ] Tests passing: Comments load and display correctly
- [ ] Documentation updated: Setup guide created
- [ ] Code reviewed: Configuration verified
- [ ] Ready for use: Can comment on models
- [ ] Verified: GitHub OAuth flow works
- [ ] Verified: Comments persist in GitHub Discussions
- [ ] Verified: Theme synchronization works
- [ ] Verified: Lazy loading activates on scroll
- [ ] Verified: Mobile-responsive comment UI
